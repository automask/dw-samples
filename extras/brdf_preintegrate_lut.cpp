#include "brdf_preintegrate_lut.h"
#include <macros.h>
#include <vk_mem_alloc.h>
#include <glm.hpp>
#include <logger.h>

#define BRDF_LUT_SIZE 512
#define BRDF_WORK_GROUP_SIZE 8

namespace dw
{
// -----------------------------------------------------------------------------------------------------------------------------------

#if defined(DWSF_VULKAN)
static const unsigned int kBRDF_PREINTEGRATE_LUT_SPIRV_size           = 8988;
static const unsigned int kBRDF_PREINTEGRATE_LUT_SPIRV_data[8988 / 4] = {
    0x07230203,
    0x00010500,
    0x0008000a,
    0x00000187,
    0x00000000,
    0x00020011,
    0x00000001,
    0x00020011,
    0x00000031,
    0x0006000b,
    0x00000001,
    0x4c534c47,
    0x6474732e,
    0x3035342e,
    0x00000000,
    0x0003000e,
    0x00000000,
    0x00000001,
    0x0007000f,
    0x00000005,
    0x00000004,
    0x6e69616d,
    0x00000000,
    0x00000162,
    0x0000017a,
    0x00060010,
    0x00000004,
    0x00000011,
    0x00000008,
    0x00000008,
    0x00000001,
    0x00030003,
    0x00000002,
    0x000001c2,
    0x00040005,
    0x00000004,
    0x6e69616d,
    0x00000000,
    0x00080005,
    0x0000000b,
    0x69646172,
    0x5f6c6163,
    0x65766e69,
    0x5f657372,
    0x28636476,
    0x003b3175,
    0x00040005,
    0x0000000a,
    0x73746962,
    0x00000000,
    0x00070005,
    0x00000011,
    0x6d6d6168,
    0x6c737265,
    0x75287965,
    0x31753b31,
    0x0000003b,
    0x00030005,
    0x0000000f,
    0x00000069,
    0x00030005,
    0x00000010,
    0x0000004e,
    0x000b0005,
    0x0000001b,
    0x6f706d69,
    0x6e617472,
    0x735f6563,
    0x6c706d61,
    0x67675f65,
    0x66762878,
    0x66763b32,
    0x31663b33,
    0x0000003b,
    0x00030005,
    0x00000018,
    0x00006958,
    0x00030005,
    0x00000019,
    0x0000004e,
    0x00050005,
    0x0000001a,
    0x67756f72,
    0x73656e68,
    0x00000073,
    0x00090005,
    0x00000020,
    0x6d6f6567,
    0x79727465,
    0x6863735f,
    0x6b63696c,
    0x7867675f,
    0x3b316628,
    0x003b3166,
    0x00040005,
    0x0000001e,
    0x746f644e,
    0x00000056,
    0x00050005,
    0x0000001f,
    0x67756f72,
    0x73656e68,
    0x00000073,
    0x000a0005,
    0x00000027,
    0x6d6f6567,
    0x79727465,
    0x696d735f,
    0x76286874,
    0x763b3366,
    0x763b3366,
    0x663b3366,
    0x00003b31,
    0x00030005,
    0x00000023,
    0x0000004e,
    0x00030005,
    0x00000024,
    0x00000056,
    0x00030005,
    0x00000025,
    0x0000004c,
    0x00050005,
    0x00000026,
    0x67756f72,
    0x73656e68,
    0x00000073,
    0x00080005,
    0x0000002c,
    0x65746e69,
    0x74617267,
    0x72625f65,
    0x66286664,
    0x31663b31,
    0x0000003b,
    0x00040005,
    0x0000002a,
    0x746f644e,
    0x00000056,
    0x00050005,
    0x0000002b,
    0x67756f72,
    0x73656e68,
    0x00000073,
    0x00040005,
    0x00000067,
    0x61726170,
    0x0000006d,
    0x00030005,
    0x0000006d,
    0x00000061,
    0x00030005,
    0x00000071,
    0x00696870,
    0x00050005,
    0x00000077,
    0x54736f63,
    0x61746568,
    0x00000000,
    0x00050005,
    0x00000086,
    0x546e6973,
    0x61746568,
    0x00000000,
    0x00030005,
    0x0000008c,
    0x00000048,
    0x00030005,
    0x00000099,
    0x00007075,
    0x00040005,
    0x000000a4,
    0x676e6174,
    0x00746e65,
    0x00050005,
    0x000000a9,
    0x61746962,
    0x6e65676e,
    0x00000074,
    0x00050005,
    0x000000ad,
    0x706d6173,
    0x6556656c,
    0x00000063,
    0x00030005,
    0x000000c0,
    0x00000061,
    0x00030005,
    0x000000c2,
    0x0000006b,
    0x00030005,
    0x000000c8,
    0x006d6f6e,
    0x00040005,
    0x000000ca,
    0x6f6e6564,
    0x0000006d,
    0x00040005,
    0x000000d6,
    0x746f644e,
    0x00000056,
    0x00040005,
    0x000000db,
    0x746f644e,
    0x0000004c,
    0x00040005,
    0x000000e0,
    0x32786767,
    0x00000000,
    0x00040005,
    0x000000e1,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x000000e3,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x000000e6,
    0x31786767,
    0x00000000,
    0x00040005,
    0x000000e7,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x000000e9,
    0x61726170,
    0x0000006d,
    0x00030005,
    0x000000f1,
    0x00000056,
    0x00030005,
    0x000000fb,
    0x00000041,
    0x00030005,
    0x000000fc,
    0x00000042,
    0x00030005,
    0x000000fd,
    0x0000004e,
    0x00030005,
    0x000000fe,
    0x00000069,
    0x00030005,
    0x00000107,
    0x00006958,
    0x00040005,
    0x00000108,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x0000010a,
    0x61726170,
    0x0000006d,
    0x00030005,
    0x0000010c,
    0x00000048,
    0x00040005,
    0x0000010d,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x0000010f,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x00000111,
    0x61726170,
    0x0000006d,
    0x00030005,
    0x00000114,
    0x0000004c,
    0x00040005,
    0x0000011e,
    0x746f644e,
    0x0000004c,
    0x00040005,
    0x00000122,
    0x746f644e,
    0x00000048,
    0x00040005,
    0x00000126,
    0x746f6456,
    0x00000048,
    0x00030005,
    0x0000012f,
    0x00000047,
    0x00040005,
    0x00000130,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x00000132,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x00000134,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x00000136,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x00000139,
    0x69565f47,
    0x00000073,
    0x00030005,
    0x00000141,
    0x00006346,
    0x00050005,
    0x0000015f,
    0x5f786574,
    0x726f6f63,
    0x00000064,
    0x00080005,
    0x00000162,
    0x475f6c67,
    0x61626f6c,
    0x766e496c,
    0x7461636f,
    0x496e6f69,
    0x00000044,
    0x00040005,
    0x00000170,
    0x66647262,
    0x00000000,
    0x00040005,
    0x00000171,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x00000174,
    0x61726170,
    0x0000006d,
    0x00040005,
    0x0000017a,
    0x52425f69,
    0x00004644,
    0x00040047,
    0x00000162,
    0x0000000b,
    0x0000001c,
    0x00040047,
    0x0000017a,
    0x00000022,
    0x00000000,
    0x00040047,
    0x0000017a,
    0x00000021,
    0x00000000,
    0x00040047,
    0x00000186,
    0x0000000b,
    0x00000019,
    0x00020013,
    0x00000002,
    0x00030021,
    0x00000003,
    0x00000002,
    0x00040015,
    0x00000006,
    0x00000020,
    0x00000000,
    0x00040020,
    0x00000007,
    0x00000007,
    0x00000006,
    0x00030016,
    0x00000008,
    0x00000020,
    0x00040021,
    0x00000009,
    0x00000008,
    0x00000007,
    0x00040017,
    0x0000000d,
    0x00000008,
    0x00000002,
    0x00050021,
    0x0000000e,
    0x0000000d,
    0x00000007,
    0x00000007,
    0x00040020,
    0x00000013,
    0x00000007,
    0x0000000d,
    0x00040017,
    0x00000014,
    0x00000008,
    0x00000003,
    0x00040020,
    0x00000015,
    0x00000007,
    0x00000014,
    0x00040020,
    0x00000016,
    0x00000007,
    0x00000008,
    0x00060021,
    0x00000017,
    0x00000014,
    0x00000013,
    0x00000015,
    0x00000016,
    0x00050021,
    0x0000001d,
    0x00000008,
    0x00000016,
    0x00000016,
    0x00070021,
    0x00000022,
    0x00000008,
    0x00000015,
    0x00000015,
    0x00000015,
    0x00000016,
    0x00050021,
    0x00000029,
    0x0000000d,
    0x00000016,
    0x00000016,
    0x0004002b,
    0x00000006,
    0x0000002f,
    0x00000010,
    0x0004002b,
    0x00000006,
    0x00000035,
    0x55555555,
    0x0004002b,
    0x00000006,
    0x00000037,
    0x00000001,
    0x0004002b,
    0x00000006,
    0x0000003a,
    0xaaaaaaaa,
    0x0004002b,
    0x00000006,
    0x0000003f,
    0x33333333,
    0x0004002b,
    0x00000006,
    0x00000041,
    0x00000002,
    0x0004002b,
    0x00000006,
    0x00000044,
    0xcccccccc,
    0x0004002b,
    0x00000006,
    0x00000049,
    0x0f0f0f0f,
    0x0004002b,
    0x00000006,
    0x0000004b,
    0x00000004,
    0x0004002b,
    0x00000006,
    0x0000004e,
    0xf0f0f0f0,
    0x0004002b,
    0x00000006,
    0x00000053,
    0x00ff00ff,
    0x0004002b,
    0x00000006,
    0x00000055,
    0x00000008,
    0x0004002b,
    0x00000006,
    0x00000058,
    0xff00ff00,
    0x0004002b,
    0x00000008,
    0x0000005e,
    0x2f800000,
    0x0004002b,
    0x00000008,
    0x00000072,
    0x40c90fdb,
    0x0004002b,
    0x00000006,
    0x00000073,
    0x00000000,
    0x0004002b,
    0x00000008,
    0x00000078,
    0x3f800000,
    0x0004002b,
    0x00000008,
    0x0000009d,
    0x3f7fbe77,
    0x00020014,
    0x0000009e,
    0x0004002b,
    0x00000008,
    0x000000a0,
    0x00000000,
    0x0006002c,
    0x00000014,
    0x000000a1,
    0x000000a0,
    0x000000a0,
    0x00000078,
    0x0006002c,
    0x00000014,
    0x000000a2,
    0x00000078,
    0x000000a0,
    0x000000a0,
    0x0004002b,
    0x00000008,
    0x000000c6,
    0x40000000,
    0x0004002b,
    0x00000006,
    0x00000105,
    0x00000400,
    0x0004002b,
    0x00000008,
    0x00000144,
    0x40a00000,
    0x00040015,
    0x00000152,
    0x00000020,
    0x00000001,
    0x0004002b,
    0x00000152,
    0x00000153,
    0x00000001,
    0x0004002b,
    0x00000008,
    0x00000155,
    0x44800000,
    0x00040017,
    0x00000160,
    0x00000006,
    0x00000003,
    0x00040020,
    0x00000161,
    0x00000001,
    0x00000160,
    0x0004003b,
    0x00000161,
    0x00000162,
    0x00000001,
    0x00040020,
    0x00000163,
    0x00000001,
    0x00000006,
    0x0004002b,
    0x00000008,
    0x0000016d,
    0x44000000,
    0x00090019,
    0x00000178,
    0x00000008,
    0x00000001,
    0x00000000,
    0x00000000,
    0x00000000,
    0x00000002,
    0x00000007,
    0x00040020,
    0x00000179,
    0x00000000,
    0x00000178,
    0x0004003b,
    0x00000179,
    0x0000017a,
    0x00000000,
    0x00040017,
    0x0000017c,
    0x00000006,
    0x00000002,
    0x00040017,
    0x0000017f,
    0x00000152,
    0x00000002,
    0x00040017,
    0x00000182,
    0x00000008,
    0x00000004,
    0x0006002c,
    0x00000160,
    0x00000186,
    0x00000055,
    0x00000055,
    0x00000037,
    0x00050036,
    0x00000002,
    0x00000004,
    0x00000000,
    0x00000003,
    0x000200f8,
    0x00000005,
    0x0004003b,
    0x00000013,
    0x0000015f,
    0x00000007,
    0x0004003b,
    0x00000013,
    0x00000170,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x00000171,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x00000174,
    0x00000007,
    0x00050041,
    0x00000163,
    0x00000164,
    0x00000162,
    0x00000073,
    0x0004003d,
    0x00000006,
    0x00000165,
    0x00000164,
    0x00050080,
    0x00000006,
    0x00000166,
    0x00000165,
    0x00000037,
    0x00040070,
    0x00000008,
    0x00000167,
    0x00000166,
    0x00050041,
    0x00000163,
    0x00000168,
    0x00000162,
    0x00000037,
    0x0004003d,
    0x00000006,
    0x00000169,
    0x00000168,
    0x00050080,
    0x00000006,
    0x0000016a,
    0x00000169,
    0x00000037,
    0x00040070,
    0x00000008,
    0x0000016b,
    0x0000016a,
    0x00050050,
    0x0000000d,
    0x0000016c,
    0x00000167,
    0x0000016b,
    0x00050050,
    0x0000000d,
    0x0000016e,
    0x0000016d,
    0x0000016d,
    0x00050088,
    0x0000000d,
    0x0000016f,
    0x0000016c,
    0x0000016e,
    0x0003003e,
    0x0000015f,
    0x0000016f,
    0x00050041,
    0x00000016,
    0x00000172,
    0x0000015f,
    0x00000073,
    0x0004003d,
    0x00000008,
    0x00000173,
    0x00000172,
    0x0003003e,
    0x00000171,
    0x00000173,
    0x00050041,
    0x00000016,
    0x00000175,
    0x0000015f,
    0x00000037,
    0x0004003d,
    0x00000008,
    0x00000176,
    0x00000175,
    0x0003003e,
    0x00000174,
    0x00000176,
    0x00060039,
    0x0000000d,
    0x00000177,
    0x0000002c,
    0x00000171,
    0x00000174,
    0x0003003e,
    0x00000170,
    0x00000177,
    0x0004003d,
    0x00000178,
    0x0000017b,
    0x0000017a,
    0x0004003d,
    0x00000160,
    0x0000017d,
    0x00000162,
    0x0007004f,
    0x0000017c,
    0x0000017e,
    0x0000017d,
    0x0000017d,
    0x00000000,
    0x00000001,
    0x0004007c,
    0x0000017f,
    0x00000180,
    0x0000017e,
    0x0004003d,
    0x0000000d,
    0x00000181,
    0x00000170,
    0x00050051,
    0x00000008,
    0x00000183,
    0x00000181,
    0x00000000,
    0x00050051,
    0x00000008,
    0x00000184,
    0x00000181,
    0x00000001,
    0x00070050,
    0x00000182,
    0x00000185,
    0x00000183,
    0x00000184,
    0x000000a0,
    0x000000a0,
    0x00040063,
    0x0000017b,
    0x00000180,
    0x00000185,
    0x000100fd,
    0x00010038,
    0x00050036,
    0x00000008,
    0x0000000b,
    0x00000000,
    0x00000009,
    0x00030037,
    0x00000007,
    0x0000000a,
    0x000200f8,
    0x0000000c,
    0x0004003d,
    0x00000006,
    0x0000002e,
    0x0000000a,
    0x000500c4,
    0x00000006,
    0x00000030,
    0x0000002e,
    0x0000002f,
    0x0004003d,
    0x00000006,
    0x00000031,
    0x0000000a,
    0x000500c2,
    0x00000006,
    0x00000032,
    0x00000031,
    0x0000002f,
    0x000500c5,
    0x00000006,
    0x00000033,
    0x00000030,
    0x00000032,
    0x0003003e,
    0x0000000a,
    0x00000033,
    0x0004003d,
    0x00000006,
    0x00000034,
    0x0000000a,
    0x000500c7,
    0x00000006,
    0x00000036,
    0x00000034,
    0x00000035,
    0x000500c4,
    0x00000006,
    0x00000038,
    0x00000036,
    0x00000037,
    0x0004003d,
    0x00000006,
    0x00000039,
    0x0000000a,
    0x000500c7,
    0x00000006,
    0x0000003b,
    0x00000039,
    0x0000003a,
    0x000500c2,
    0x00000006,
    0x0000003c,
    0x0000003b,
    0x00000037,
    0x000500c5,
    0x00000006,
    0x0000003d,
    0x00000038,
    0x0000003c,
    0x0003003e,
    0x0000000a,
    0x0000003d,
    0x0004003d,
    0x00000006,
    0x0000003e,
    0x0000000a,
    0x000500c7,
    0x00000006,
    0x00000040,
    0x0000003e,
    0x0000003f,
    0x000500c4,
    0x00000006,
    0x00000042,
    0x00000040,
    0x00000041,
    0x0004003d,
    0x00000006,
    0x00000043,
    0x0000000a,
    0x000500c7,
    0x00000006,
    0x00000045,
    0x00000043,
    0x00000044,
    0x000500c2,
    0x00000006,
    0x00000046,
    0x00000045,
    0x00000041,
    0x000500c5,
    0x00000006,
    0x00000047,
    0x00000042,
    0x00000046,
    0x0003003e,
    0x0000000a,
    0x00000047,
    0x0004003d,
    0x00000006,
    0x00000048,
    0x0000000a,
    0x000500c7,
    0x00000006,
    0x0000004a,
    0x00000048,
    0x00000049,
    0x000500c4,
    0x00000006,
    0x0000004c,
    0x0000004a,
    0x0000004b,
    0x0004003d,
    0x00000006,
    0x0000004d,
    0x0000000a,
    0x000500c7,
    0x00000006,
    0x0000004f,
    0x0000004d,
    0x0000004e,
    0x000500c2,
    0x00000006,
    0x00000050,
    0x0000004f,
    0x0000004b,
    0x000500c5,
    0x00000006,
    0x00000051,
    0x0000004c,
    0x00000050,
    0x0003003e,
    0x0000000a,
    0x00000051,
    0x0004003d,
    0x00000006,
    0x00000052,
    0x0000000a,
    0x000500c7,
    0x00000006,
    0x00000054,
    0x00000052,
    0x00000053,
    0x000500c4,
    0x00000006,
    0x00000056,
    0x00000054,
    0x00000055,
    0x0004003d,
    0x00000006,
    0x00000057,
    0x0000000a,
    0x000500c7,
    0x00000006,
    0x00000059,
    0x00000057,
    0x00000058,
    0x000500c2,
    0x00000006,
    0x0000005a,
    0x00000059,
    0x00000055,
    0x000500c5,
    0x00000006,
    0x0000005b,
    0x00000056,
    0x0000005a,
    0x0003003e,
    0x0000000a,
    0x0000005b,
    0x0004003d,
    0x00000006,
    0x0000005c,
    0x0000000a,
    0x00040070,
    0x00000008,
    0x0000005d,
    0x0000005c,
    0x00050085,
    0x00000008,
    0x0000005f,
    0x0000005d,
    0x0000005e,
    0x000200fe,
    0x0000005f,
    0x00010038,
    0x00050036,
    0x0000000d,
    0x00000011,
    0x00000000,
    0x0000000e,
    0x00030037,
    0x00000007,
    0x0000000f,
    0x00030037,
    0x00000007,
    0x00000010,
    0x000200f8,
    0x00000012,
    0x0004003b,
    0x00000007,
    0x00000067,
    0x00000007,
    0x0004003d,
    0x00000006,
    0x00000062,
    0x0000000f,
    0x00040070,
    0x00000008,
    0x00000063,
    0x00000062,
    0x0004003d,
    0x00000006,
    0x00000064,
    0x00000010,
    0x00040070,
    0x00000008,
    0x00000065,
    0x00000064,
    0x00050088,
    0x00000008,
    0x00000066,
    0x00000063,
    0x00000065,
    0x0004003d,
    0x00000006,
    0x00000068,
    0x0000000f,
    0x0003003e,
    0x00000067,
    0x00000068,
    0x00050039,
    0x00000008,
    0x00000069,
    0x0000000b,
    0x00000067,
    0x00050050,
    0x0000000d,
    0x0000006a,
    0x00000066,
    0x00000069,
    0x000200fe,
    0x0000006a,
    0x00010038,
    0x00050036,
    0x00000014,
    0x0000001b,
    0x00000000,
    0x00000017,
    0x00030037,
    0x00000013,
    0x00000018,
    0x00030037,
    0x00000015,
    0x00000019,
    0x00030037,
    0x00000016,
    0x0000001a,
    0x000200f8,
    0x0000001c,
    0x0004003b,
    0x00000016,
    0x0000006d,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x00000071,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x00000077,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x00000086,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x0000008c,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x00000099,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x000000a4,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x000000a9,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x000000ad,
    0x00000007,
    0x0004003d,
    0x00000008,
    0x0000006e,
    0x0000001a,
    0x0004003d,
    0x00000008,
    0x0000006f,
    0x0000001a,
    0x00050085,
    0x00000008,
    0x00000070,
    0x0000006e,
    0x0000006f,
    0x0003003e,
    0x0000006d,
    0x00000070,
    0x00050041,
    0x00000016,
    0x00000074,
    0x00000018,
    0x00000073,
    0x0004003d,
    0x00000008,
    0x00000075,
    0x00000074,
    0x00050085,
    0x00000008,
    0x00000076,
    0x00000072,
    0x00000075,
    0x0003003e,
    0x00000071,
    0x00000076,
    0x00050041,
    0x00000016,
    0x00000079,
    0x00000018,
    0x00000037,
    0x0004003d,
    0x00000008,
    0x0000007a,
    0x00000079,
    0x00050083,
    0x00000008,
    0x0000007b,
    0x00000078,
    0x0000007a,
    0x0004003d,
    0x00000008,
    0x0000007c,
    0x0000006d,
    0x0004003d,
    0x00000008,
    0x0000007d,
    0x0000006d,
    0x00050085,
    0x00000008,
    0x0000007e,
    0x0000007c,
    0x0000007d,
    0x00050083,
    0x00000008,
    0x0000007f,
    0x0000007e,
    0x00000078,
    0x00050041,
    0x00000016,
    0x00000080,
    0x00000018,
    0x00000037,
    0x0004003d,
    0x00000008,
    0x00000081,
    0x00000080,
    0x00050085,
    0x00000008,
    0x00000082,
    0x0000007f,
    0x00000081,
    0x00050081,
    0x00000008,
    0x00000083,
    0x00000078,
    0x00000082,
    0x00050088,
    0x00000008,
    0x00000084,
    0x0000007b,
    0x00000083,
    0x0006000c,
    0x00000008,
    0x00000085,
    0x00000001,
    0x0000001f,
    0x00000084,
    0x0003003e,
    0x00000077,
    0x00000085,
    0x0004003d,
    0x00000008,
    0x00000087,
    0x00000077,
    0x0004003d,
    0x00000008,
    0x00000088,
    0x00000077,
    0x00050085,
    0x00000008,
    0x00000089,
    0x00000087,
    0x00000088,
    0x00050083,
    0x00000008,
    0x0000008a,
    0x00000078,
    0x00000089,
    0x0006000c,
    0x00000008,
    0x0000008b,
    0x00000001,
    0x0000001f,
    0x0000008a,
    0x0003003e,
    0x00000086,
    0x0000008b,
    0x0004003d,
    0x00000008,
    0x0000008d,
    0x00000071,
    0x0006000c,
    0x00000008,
    0x0000008e,
    0x00000001,
    0x0000000e,
    0x0000008d,
    0x0004003d,
    0x00000008,
    0x0000008f,
    0x00000086,
    0x00050085,
    0x00000008,
    0x00000090,
    0x0000008e,
    0x0000008f,
    0x00050041,
    0x00000016,
    0x00000091,
    0x0000008c,
    0x00000073,
    0x0003003e,
    0x00000091,
    0x00000090,
    0x0004003d,
    0x00000008,
    0x00000092,
    0x00000071,
    0x0006000c,
    0x00000008,
    0x00000093,
    0x00000001,
    0x0000000d,
    0x00000092,
    0x0004003d,
    0x00000008,
    0x00000094,
    0x00000086,
    0x00050085,
    0x00000008,
    0x00000095,
    0x00000093,
    0x00000094,
    0x00050041,
    0x00000016,
    0x00000096,
    0x0000008c,
    0x00000037,
    0x0003003e,
    0x00000096,
    0x00000095,
    0x0004003d,
    0x00000008,
    0x00000097,
    0x00000077,
    0x00050041,
    0x00000016,
    0x00000098,
    0x0000008c,
    0x00000041,
    0x0003003e,
    0x00000098,
    0x00000097,
    0x00050041,
    0x00000016,
    0x0000009a,
    0x00000019,
    0x00000041,
    0x0004003d,
    0x00000008,
    0x0000009b,
    0x0000009a,
    0x0006000c,
    0x00000008,
    0x0000009c,
    0x00000001,
    0x00000004,
    0x0000009b,
    0x000500b8,
    0x0000009e,
    0x0000009f,
    0x0000009c,
    0x0000009d,
    0x000600a9,
    0x00000014,
    0x000000a3,
    0x0000009f,
    0x000000a1,
    0x000000a2,
    0x0003003e,
    0x00000099,
    0x000000a3,
    0x0004003d,
    0x00000014,
    0x000000a5,
    0x00000099,
    0x0004003d,
    0x00000014,
    0x000000a6,
    0x00000019,
    0x0007000c,
    0x00000014,
    0x000000a7,
    0x00000001,
    0x00000044,
    0x000000a5,
    0x000000a6,
    0x0006000c,
    0x00000014,
    0x000000a8,
    0x00000001,
    0x00000045,
    0x000000a7,
    0x0003003e,
    0x000000a4,
    0x000000a8,
    0x0004003d,
    0x00000014,
    0x000000aa,
    0x00000019,
    0x0004003d,
    0x00000014,
    0x000000ab,
    0x000000a4,
    0x0007000c,
    0x00000014,
    0x000000ac,
    0x00000001,
    0x00000044,
    0x000000aa,
    0x000000ab,
    0x0003003e,
    0x000000a9,
    0x000000ac,
    0x0004003d,
    0x00000014,
    0x000000ae,
    0x000000a4,
    0x00050041,
    0x00000016,
    0x000000af,
    0x0000008c,
    0x00000073,
    0x0004003d,
    0x00000008,
    0x000000b0,
    0x000000af,
    0x0005008e,
    0x00000014,
    0x000000b1,
    0x000000ae,
    0x000000b0,
    0x0004003d,
    0x00000014,
    0x000000b2,
    0x000000a9,
    0x00050041,
    0x00000016,
    0x000000b3,
    0x0000008c,
    0x00000037,
    0x0004003d,
    0x00000008,
    0x000000b4,
    0x000000b3,
    0x0005008e,
    0x00000014,
    0x000000b5,
    0x000000b2,
    0x000000b4,
    0x00050081,
    0x00000014,
    0x000000b6,
    0x000000b1,
    0x000000b5,
    0x0004003d,
    0x00000014,
    0x000000b7,
    0x00000019,
    0x00050041,
    0x00000016,
    0x000000b8,
    0x0000008c,
    0x00000041,
    0x0004003d,
    0x00000008,
    0x000000b9,
    0x000000b8,
    0x0005008e,
    0x00000014,
    0x000000ba,
    0x000000b7,
    0x000000b9,
    0x00050081,
    0x00000014,
    0x000000bb,
    0x000000b6,
    0x000000ba,
    0x0003003e,
    0x000000ad,
    0x000000bb,
    0x0004003d,
    0x00000014,
    0x000000bc,
    0x000000ad,
    0x0006000c,
    0x00000014,
    0x000000bd,
    0x00000001,
    0x00000045,
    0x000000bc,
    0x000200fe,
    0x000000bd,
    0x00010038,
    0x00050036,
    0x00000008,
    0x00000020,
    0x00000000,
    0x0000001d,
    0x00030037,
    0x00000016,
    0x0000001e,
    0x00030037,
    0x00000016,
    0x0000001f,
    0x000200f8,
    0x00000021,
    0x0004003b,
    0x00000016,
    0x000000c0,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000c2,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000c8,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000ca,
    0x00000007,
    0x0004003d,
    0x00000008,
    0x000000c1,
    0x0000001f,
    0x0003003e,
    0x000000c0,
    0x000000c1,
    0x0004003d,
    0x00000008,
    0x000000c3,
    0x000000c0,
    0x0004003d,
    0x00000008,
    0x000000c4,
    0x000000c0,
    0x00050085,
    0x00000008,
    0x000000c5,
    0x000000c3,
    0x000000c4,
    0x00050088,
    0x00000008,
    0x000000c7,
    0x000000c5,
    0x000000c6,
    0x0003003e,
    0x000000c2,
    0x000000c7,
    0x0004003d,
    0x00000008,
    0x000000c9,
    0x0000001e,
    0x0003003e,
    0x000000c8,
    0x000000c9,
    0x0004003d,
    0x00000008,
    0x000000cb,
    0x0000001e,
    0x0004003d,
    0x00000008,
    0x000000cc,
    0x000000c2,
    0x00050083,
    0x00000008,
    0x000000cd,
    0x00000078,
    0x000000cc,
    0x00050085,
    0x00000008,
    0x000000ce,
    0x000000cb,
    0x000000cd,
    0x0004003d,
    0x00000008,
    0x000000cf,
    0x000000c2,
    0x00050081,
    0x00000008,
    0x000000d0,
    0x000000ce,
    0x000000cf,
    0x0003003e,
    0x000000ca,
    0x000000d0,
    0x0004003d,
    0x00000008,
    0x000000d1,
    0x000000c8,
    0x0004003d,
    0x00000008,
    0x000000d2,
    0x000000ca,
    0x00050088,
    0x00000008,
    0x000000d3,
    0x000000d1,
    0x000000d2,
    0x000200fe,
    0x000000d3,
    0x00010038,
    0x00050036,
    0x00000008,
    0x00000027,
    0x00000000,
    0x00000022,
    0x00030037,
    0x00000015,
    0x00000023,
    0x00030037,
    0x00000015,
    0x00000024,
    0x00030037,
    0x00000015,
    0x00000025,
    0x00030037,
    0x00000016,
    0x00000026,
    0x000200f8,
    0x00000028,
    0x0004003b,
    0x00000016,
    0x000000d6,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000db,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000e0,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000e1,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000e3,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000e6,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000e7,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000e9,
    0x00000007,
    0x0004003d,
    0x00000014,
    0x000000d7,
    0x00000023,
    0x0004003d,
    0x00000014,
    0x000000d8,
    0x00000024,
    0x00050094,
    0x00000008,
    0x000000d9,
    0x000000d7,
    0x000000d8,
    0x0007000c,
    0x00000008,
    0x000000da,
    0x00000001,
    0x00000028,
    0x000000d9,
    0x000000a0,
    0x0003003e,
    0x000000d6,
    0x000000da,
    0x0004003d,
    0x00000014,
    0x000000dc,
    0x00000023,
    0x0004003d,
    0x00000014,
    0x000000dd,
    0x00000025,
    0x00050094,
    0x00000008,
    0x000000de,
    0x000000dc,
    0x000000dd,
    0x0007000c,
    0x00000008,
    0x000000df,
    0x00000001,
    0x00000028,
    0x000000de,
    0x000000a0,
    0x0003003e,
    0x000000db,
    0x000000df,
    0x0004003d,
    0x00000008,
    0x000000e2,
    0x000000d6,
    0x0003003e,
    0x000000e1,
    0x000000e2,
    0x0004003d,
    0x00000008,
    0x000000e4,
    0x00000026,
    0x0003003e,
    0x000000e3,
    0x000000e4,
    0x00060039,
    0x00000008,
    0x000000e5,
    0x00000020,
    0x000000e1,
    0x000000e3,
    0x0003003e,
    0x000000e0,
    0x000000e5,
    0x0004003d,
    0x00000008,
    0x000000e8,
    0x000000db,
    0x0003003e,
    0x000000e7,
    0x000000e8,
    0x0004003d,
    0x00000008,
    0x000000ea,
    0x00000026,
    0x0003003e,
    0x000000e9,
    0x000000ea,
    0x00060039,
    0x00000008,
    0x000000eb,
    0x00000020,
    0x000000e7,
    0x000000e9,
    0x0003003e,
    0x000000e6,
    0x000000eb,
    0x0004003d,
    0x00000008,
    0x000000ec,
    0x000000e6,
    0x0004003d,
    0x00000008,
    0x000000ed,
    0x000000e0,
    0x00050085,
    0x00000008,
    0x000000ee,
    0x000000ec,
    0x000000ed,
    0x000200fe,
    0x000000ee,
    0x00010038,
    0x00050036,
    0x0000000d,
    0x0000002c,
    0x00000000,
    0x00000029,
    0x00030037,
    0x00000016,
    0x0000002a,
    0x00030037,
    0x00000016,
    0x0000002b,
    0x000200f8,
    0x0000002d,
    0x0004003b,
    0x00000015,
    0x000000f1,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000fb,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x000000fc,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x000000fd,
    0x00000007,
    0x0004003b,
    0x00000007,
    0x000000fe,
    0x00000007,
    0x0004003b,
    0x00000013,
    0x00000107,
    0x00000007,
    0x0004003b,
    0x00000007,
    0x00000108,
    0x00000007,
    0x0004003b,
    0x00000007,
    0x0000010a,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x0000010c,
    0x00000007,
    0x0004003b,
    0x00000013,
    0x0000010d,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x0000010f,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x00000111,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x00000114,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x0000011e,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x00000122,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x00000126,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x0000012f,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x00000130,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x00000132,
    0x00000007,
    0x0004003b,
    0x00000015,
    0x00000134,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x00000136,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x00000139,
    0x00000007,
    0x0004003b,
    0x00000016,
    0x00000141,
    0x00000007,
    0x0004003d,
    0x00000008,
    0x000000f2,
    0x0000002a,
    0x0004003d,
    0x00000008,
    0x000000f3,
    0x0000002a,
    0x00050085,
    0x00000008,
    0x000000f4,
    0x000000f2,
    0x000000f3,
    0x00050083,
    0x00000008,
    0x000000f5,
    0x00000078,
    0x000000f4,
    0x0006000c,
    0x00000008,
    0x000000f6,
    0x00000001,
    0x0000001f,
    0x000000f5,
    0x00050041,
    0x00000016,
    0x000000f7,
    0x000000f1,
    0x00000073,
    0x0003003e,
    0x000000f7,
    0x000000f6,
    0x00050041,
    0x00000016,
    0x000000f8,
    0x000000f1,
    0x00000037,
    0x0003003e,
    0x000000f8,
    0x000000a0,
    0x0004003d,
    0x00000008,
    0x000000f9,
    0x0000002a,
    0x00050041,
    0x00000016,
    0x000000fa,
    0x000000f1,
    0x00000041,
    0x0003003e,
    0x000000fa,
    0x000000f9,
    0x0003003e,
    0x000000fb,
    0x000000a0,
    0x0003003e,
    0x000000fc,
    0x000000a0,
    0x0003003e,
    0x000000fd,
    0x000000a1,
    0x0003003e,
    0x000000fe,
    0x00000073,
    0x000200f9,
    0x000000ff,
    0x000200f8,
    0x000000ff,
    0x000400f6,
    0x00000101,
    0x00000102,
    0x00000000,
    0x000200f9,
    0x00000103,
    0x000200f8,
    0x00000103,
    0x0004003d,
    0x00000006,
    0x00000104,
    0x000000fe,
    0x000500b0,
    0x0000009e,
    0x00000106,
    0x00000104,
    0x00000105,
    0x000400fa,
    0x00000106,
    0x00000100,
    0x00000101,
    0x000200f8,
    0x00000100,
    0x0004003d,
    0x00000006,
    0x00000109,
    0x000000fe,
    0x0003003e,
    0x00000108,
    0x00000109,
    0x0003003e,
    0x0000010a,
    0x00000105,
    0x00060039,
    0x0000000d,
    0x0000010b,
    0x00000011,
    0x00000108,
    0x0000010a,
    0x0003003e,
    0x00000107,
    0x0000010b,
    0x0004003d,
    0x0000000d,
    0x0000010e,
    0x00000107,
    0x0003003e,
    0x0000010d,
    0x0000010e,
    0x0004003d,
    0x00000014,
    0x00000110,
    0x000000fd,
    0x0003003e,
    0x0000010f,
    0x00000110,
    0x0004003d,
    0x00000008,
    0x00000112,
    0x0000002b,
    0x0003003e,
    0x00000111,
    0x00000112,
    0x00070039,
    0x00000014,
    0x00000113,
    0x0000001b,
    0x0000010d,
    0x0000010f,
    0x00000111,
    0x0003003e,
    0x0000010c,
    0x00000113,
    0x0004003d,
    0x00000014,
    0x00000115,
    0x000000f1,
    0x0004003d,
    0x00000014,
    0x00000116,
    0x0000010c,
    0x00050094,
    0x00000008,
    0x00000117,
    0x00000115,
    0x00000116,
    0x00050085,
    0x00000008,
    0x00000118,
    0x000000c6,
    0x00000117,
    0x0004003d,
    0x00000014,
    0x00000119,
    0x0000010c,
    0x0005008e,
    0x00000014,
    0x0000011a,
    0x00000119,
    0x00000118,
    0x0004003d,
    0x00000014,
    0x0000011b,
    0x000000f1,
    0x00050083,
    0x00000014,
    0x0000011c,
    0x0000011a,
    0x0000011b,
    0x0006000c,
    0x00000014,
    0x0000011d,
    0x00000001,
    0x00000045,
    0x0000011c,
    0x0003003e,
    0x00000114,
    0x0000011d,
    0x00050041,
    0x00000016,
    0x0000011f,
    0x00000114,
    0x00000041,
    0x0004003d,
    0x00000008,
    0x00000120,
    0x0000011f,
    0x0007000c,
    0x00000008,
    0x00000121,
    0x00000001,
    0x00000028,
    0x00000120,
    0x000000a0,
    0x0003003e,
    0x0000011e,
    0x00000121,
    0x00050041,
    0x00000016,
    0x00000123,
    0x0000010c,
    0x00000041,
    0x0004003d,
    0x00000008,
    0x00000124,
    0x00000123,
    0x0007000c,
    0x00000008,
    0x00000125,
    0x00000001,
    0x00000028,
    0x00000124,
    0x000000a0,
    0x0003003e,
    0x00000122,
    0x00000125,
    0x0004003d,
    0x00000014,
    0x00000127,
    0x000000f1,
    0x0004003d,
    0x00000014,
    0x00000128,
    0x0000010c,
    0x00050094,
    0x00000008,
    0x00000129,
    0x00000127,
    0x00000128,
    0x0007000c,
    0x00000008,
    0x0000012a,
    0x00000001,
    0x00000028,
    0x00000129,
    0x000000a0,
    0x0003003e,
    0x00000126,
    0x0000012a,
    0x0004003d,
    0x00000008,
    0x0000012b,
    0x0000011e,
    0x000500ba,
    0x0000009e,
    0x0000012c,
    0x0000012b,
    0x000000a0,
    0x000300f7,
    0x0000012e,
    0x00000000,
    0x000400fa,
    0x0000012c,
    0x0000012d,
    0x0000012e,
    0x000200f8,
    0x0000012d,
    0x0004003d,
    0x00000014,
    0x00000131,
    0x000000fd,
    0x0003003e,
    0x00000130,
    0x00000131,
    0x0004003d,
    0x00000014,
    0x00000133,
    0x000000f1,
    0x0003003e,
    0x00000132,
    0x00000133,
    0x0004003d,
    0x00000014,
    0x00000135,
    0x00000114,
    0x0003003e,
    0x00000134,
    0x00000135,
    0x0004003d,
    0x00000008,
    0x00000137,
    0x0000002b,
    0x0003003e,
    0x00000136,
    0x00000137,
    0x00080039,
    0x00000008,
    0x00000138,
    0x00000027,
    0x00000130,
    0x00000132,
    0x00000134,
    0x00000136,
    0x0003003e,
    0x0000012f,
    0x00000138,
    0x0004003d,
    0x00000008,
    0x0000013a,
    0x0000012f,
    0x0004003d,
    0x00000008,
    0x0000013b,
    0x00000126,
    0x00050085,
    0x00000008,
    0x0000013c,
    0x0000013a,
    0x0000013b,
    0x0004003d,
    0x00000008,
    0x0000013d,
    0x00000122,
    0x0004003d,
    0x00000008,
    0x0000013e,
    0x0000002a,
    0x00050085,
    0x00000008,
    0x0000013f,
    0x0000013d,
    0x0000013e,
    0x00050088,
    0x00000008,
    0x00000140,
    0x0000013c,
    0x0000013f,
    0x0003003e,
    0x00000139,
    0x00000140,
    0x0004003d,
    0x00000008,
    0x00000142,
    0x00000126,
    0x00050083,
    0x00000008,
    0x00000143,
    0x00000078,
    0x00000142,
    0x0007000c,
    0x00000008,
    0x00000145,
    0x00000001,
    0x0000001a,
    0x00000143,
    0x00000144,
    0x0003003e,
    0x00000141,
    0x00000145,
    0x0004003d,
    0x00000008,
    0x00000146,
    0x00000141,
    0x00050083,
    0x00000008,
    0x00000147,
    0x00000078,
    0x00000146,
    0x0004003d,
    0x00000008,
    0x00000148,
    0x00000139,
    0x00050085,
    0x00000008,
    0x00000149,
    0x00000147,
    0x00000148,
    0x0004003d,
    0x00000008,
    0x0000014a,
    0x000000fb,
    0x00050081,
    0x00000008,
    0x0000014b,
    0x0000014a,
    0x00000149,
    0x0003003e,
    0x000000fb,
    0x0000014b,
    0x0004003d,
    0x00000008,
    0x0000014c,
    0x00000141,
    0x0004003d,
    0x00000008,
    0x0000014d,
    0x00000139,
    0x00050085,
    0x00000008,
    0x0000014e,
    0x0000014c,
    0x0000014d,
    0x0004003d,
    0x00000008,
    0x0000014f,
    0x000000fc,
    0x00050081,
    0x00000008,
    0x00000150,
    0x0000014f,
    0x0000014e,
    0x0003003e,
    0x000000fc,
    0x00000150,
    0x000200f9,
    0x0000012e,
    0x000200f8,
    0x0000012e,
    0x000200f9,
    0x00000102,
    0x000200f8,
    0x00000102,
    0x0004003d,
    0x00000006,
    0x00000151,
    0x000000fe,
    0x00050080,
    0x00000006,
    0x00000154,
    0x00000151,
    0x00000153,
    0x0003003e,
    0x000000fe,
    0x00000154,
    0x000200f9,
    0x000000ff,
    0x000200f8,
    0x00000101,
    0x0004003d,
    0x00000008,
    0x00000156,
    0x000000fb,
    0x00050088,
    0x00000008,
    0x00000157,
    0x00000156,
    0x00000155,
    0x0003003e,
    0x000000fb,
    0x00000157,
    0x0004003d,
    0x00000008,
    0x00000158,
    0x000000fc,
    0x00050088,
    0x00000008,
    0x00000159,
    0x00000158,
    0x00000155,
    0x0003003e,
    0x000000fc,
    0x00000159,
    0x0004003d,
    0x00000008,
    0x0000015a,
    0x000000fb,
    0x0004003d,
    0x00000008,
    0x0000015b,
    0x000000fc,
    0x00050050,
    0x0000000d,
    0x0000015c,
    0x0000015a,
    0x0000015b,
    0x000200fe,
    0x0000015c,
    0x00010038,
};
#else
static const char* g_cs_src = R"(

// ------------------------------------------------------------------
// CONSTANTS --------------------------------------------------------
// ------------------------------------------------------------------

#define LOCAL_SIZE 8
#define PI 3.14159265359
#define BRDF_LUT_SIZE 512

// ------------------------------------------------------------------
// INPUTS -----------------------------------------------------------
// ------------------------------------------------------------------

layout(local_size_x = LOCAL_SIZE, local_size_y = LOCAL_SIZE, local_size_z = 1) in;

// ------------------------------------------------------------------
// OUTPUTS ----------------------------------------------------------
// ------------------------------------------------------------------

layout(binding = 0, rg16f) uniform image2D i_BRDF;

// ------------------------------------------------------------------
// FUNCTIONS --------------------------------------------------------
// ------------------------------------------------------------------

// http://holger.dammertz.org/stuff/notes_hammersleyOnHemisphere.html
// efficient VanDerCorpus calculation.
float radical_inverse_vdc(uint bits)
{
    bits = (bits << 16u) | (bits >> 16u);
    bits = ((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);
    bits = ((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);
    bits = ((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);
    bits = ((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);
    return float(bits) * 2.3283064365386963e-10; // / 0x100000000
}

// ------------------------------------------------------------------

vec2 hammersley(uint i, uint N)
{
    return vec2(float(i) / float(N), radical_inverse_vdc(i));
}

// ------------------------------------------------------------------

vec3 importance_sample_ggx(vec2 Xi, vec3 N, float roughness)
{
    float a = roughness * roughness;

    float phi      = 2.0 * PI * Xi.x;
    float cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y));
    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);

    // from spherical coordinates to cartesian coordinates - halfway vector
    vec3 H;
    H.x = cos(phi) * sinTheta;
    H.y = sin(phi) * sinTheta;
    H.z = cosTheta;

    // from tangent-space H vector to world-space sample vector
    vec3 up        = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);
    vec3 tangent   = normalize(cross(up, N));
    vec3 bitangent = cross(N, tangent);

    vec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;
    return normalize(sampleVec);
}

// ------------------------------------------------------------------

float geometry_schlick_ggx(float NdotV, float roughness)
{
    // note that we use a different k for IBL
    float a = roughness;
    float k = (a * a) / 2.0;

    float nom   = NdotV;
    float denom = NdotV * (1.0 - k) + k;

    return nom / denom;
}

// ------------------------------------------------------------------

float geometry_smith(vec3 N, vec3 V, vec3 L, float roughness)
{
    float NdotV = max(dot(N, V), 0.0);
    float NdotL = max(dot(N, L), 0.0);
    float ggx2  = geometry_schlick_ggx(NdotV, roughness);
    float ggx1  = geometry_schlick_ggx(NdotL, roughness);

    return ggx1 * ggx2;
}

// ------------------------------------------------------------------

vec2 integrate_brdf(float NdotV, float roughness)
{
    vec3 V;
    V.x = sqrt(1.0 - NdotV * NdotV);
    V.y = 0.0;
    V.z = NdotV;

    float A = 0.0;
    float B = 0.0;

    vec3 N = vec3(0.0, 0.0, 1.0);

    const uint SAMPLE_COUNT = 1024u;
    for (uint i = 0u; i < SAMPLE_COUNT; ++i)
    {
        // generates a sample vector that's biased towards the
        // preferred alignment direction (importance sampling).
        vec2 Xi = hammersley(i, SAMPLE_COUNT);
        vec3 H  = importance_sample_ggx(Xi, N, roughness);
        vec3 L  = normalize(2.0 * dot(V, H) * H - V);

        float NdotL = max(L.z, 0.0);
        float NdotH = max(H.z, 0.0);
        float VdotH = max(dot(V, H), 0.0);

        if (NdotL > 0.0)
        {
            float G     = geometry_smith(N, V, L, roughness);
            float G_Vis = (G * VdotH) / (NdotH * NdotV);
            float Fc    = pow(1.0 - VdotH, 5.0);

            A += (1.0 - Fc) * G_Vis;
            B += Fc * G_Vis;
        }
    }
    A /= float(SAMPLE_COUNT);
    B /= float(SAMPLE_COUNT);
    return vec2(A, B);
}

// ------------------------------------------------------------------
// MAIN -------------------------------------------------------------
// ------------------------------------------------------------------

void main()
{
    vec2 tex_coord = vec2(float(gl_GlobalInvocationID.x + 1), float(gl_GlobalInvocationID.y + 1)) / float(BRDF_LUT_SIZE);
    vec2 brdf      = integrate_brdf(tex_coord.x, tex_coord.y);

    imageStore(i_BRDF, ivec2(gl_GlobalInvocationID.xy), vec4(brdf, 0.0, 0.0));
}

// ------------------------------------------------------------------

	)";
#endif

// -----------------------------------------------------------------------------------------------------------------------------------

BRDFIntegrateLUT::BRDFIntegrateLUT(
#if defined(DWSF_VULKAN)
    vk::Backend::Ptr backend
#endif
)
{
#if defined(DWSF_VULKAN)
    vk::DescriptorSetLayout::Desc ds_layout_desc;

    ds_layout_desc.add_binding(0, VK_DESCRIPTOR_TYPE_STORAGE_IMAGE, 1, VK_SHADER_STAGE_COMPUTE_BIT);

    m_ds_layout = vk::DescriptorSetLayout::create(backend, ds_layout_desc);
    
    m_ds = backend->allocate_descriptor_set(m_ds_layout);

    m_image = vk::Image::create(backend, VK_IMAGE_TYPE_2D, BRDF_LUT_SIZE, BRDF_LUT_SIZE, 1, 1, 1, VK_FORMAT_R16G16_SFLOAT, VMA_MEMORY_USAGE_GPU_ONLY, VK_IMAGE_USAGE_SAMPLED_BIT | VK_IMAGE_USAGE_STORAGE_BIT, VK_SAMPLE_COUNT_1_BIT, VK_IMAGE_LAYOUT_UNDEFINED);
    m_image->set_name("BRDF LUT");

    m_image_view = vk::ImageView::create(backend, m_image, VK_IMAGE_VIEW_TYPE_2D, VK_IMAGE_ASPECT_COLOR_BIT, 0, 1, 0, 1);
    m_image_view->set_name("BRDF LUT");

    VkWriteDescriptorSet write_data;
    DW_ZERO_MEMORY(write_data);

    VkDescriptorImageInfo output_image;

    output_image.sampler     = VK_NULL_HANDLE;
    output_image.imageView   = m_image_view->handle();
    output_image.imageLayout = VK_IMAGE_LAYOUT_GENERAL;

    write_data.sType           = VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET;
    write_data.descriptorCount = 1;
    write_data.descriptorType  = VK_DESCRIPTOR_TYPE_STORAGE_IMAGE;
    write_data.pImageInfo      = &output_image;
    write_data.dstBinding      = 0;
    write_data.dstSet          = m_ds->handle();

    vkUpdateDescriptorSets(backend->device(), 1, &write_data, 0, nullptr);

    vk::PipelineLayout::Desc desc;

    desc.add_descriptor_set_layout(m_ds_layout);

    m_pipeline_layout = dw::vk::PipelineLayout::create(backend, desc);

    std::vector<char> spirv;

    spirv.resize(kBRDF_PREINTEGRATE_LUT_SPIRV_size);
    memcpy(&spirv[0], &kBRDF_PREINTEGRATE_LUT_SPIRV_data[0], kBRDF_PREINTEGRATE_LUT_SPIRV_size);

    vk::ShaderModule::Ptr module = dw::vk::ShaderModule::create(backend, spirv);

    vk::ComputePipeline::Desc comp_desc;

    comp_desc.set_pipeline_layout(m_pipeline_layout);
    comp_desc.set_shader_stage(module, "main");

    m_pipeline = dw::vk::ComputePipeline::create(backend, comp_desc);

    dw::vk::CommandBuffer::Ptr cmd_buf = backend->allocate_graphics_command_buffer(true);

    VkImageSubresourceRange subresource_range = { VK_IMAGE_ASPECT_COLOR_BIT, 0, 1, 0, 1 };

    dw::vk::utilities::set_image_layout(
        cmd_buf->handle(),
        m_image->handle(),
        VK_IMAGE_LAYOUT_UNDEFINED,
        VK_IMAGE_LAYOUT_GENERAL,
        subresource_range);

    vkCmdBindPipeline(cmd_buf->handle(), VK_PIPELINE_BIND_POINT_COMPUTE, m_pipeline->handle());

    vkCmdBindDescriptorSets(cmd_buf->handle(), VK_PIPELINE_BIND_POINT_COMPUTE, m_pipeline_layout->handle(), 0, 1, &m_ds->handle(), 0, nullptr);

    vkCmdDispatch(cmd_buf->handle(), BRDF_LUT_SIZE / BRDF_WORK_GROUP_SIZE, BRDF_LUT_SIZE / BRDF_WORK_GROUP_SIZE, 1);

    dw::vk::utilities::set_image_layout(
        cmd_buf->handle(),
        m_image->handle(),
        VK_IMAGE_LAYOUT_GENERAL,
        VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL,
        subresource_range);

    vkEndCommandBuffer(cmd_buf->handle());

    backend->flush_graphics({ cmd_buf });

#else
    m_texture = gl::Texture2D::create(BRDF_LUT_SIZE, BRDF_LUT_SIZE, 1, 1, 1, GL_RG16F, GL_RG, GL_HALF_FLOAT);
    m_texture->set_name("BRDF LUT");

    m_texture->set_min_filter(GL_NEAREST);
    m_texture->set_mag_filter(GL_NEAREST);

    // Create general shaders
    m_shader = gl::Shader::create(GL_COMPUTE_SHADER, g_cs_src);

    if (!m_shader->compiled())
    {
        DW_LOG_FATAL("Failed to create Shaders");
    }

    // Create general shader program
    m_program = gl::Program::create({ m_shader });

    if (!m_program)
    {
        DW_LOG_FATAL("Failed to create Shader Program");
    }

    m_program->use();

    m_texture->bind_image(0, 0, 0, GL_WRITE_ONLY, GL_RG16F);

    glDispatchCompute(BRDF_LUT_SIZE / BRDF_WORK_GROUP_SIZE, BRDF_LUT_SIZE / BRDF_WORK_GROUP_SIZE, 1);

    glMemoryBarrier(GL_SHADER_STORAGE_BARRIER_BIT);

    glFinish();
#endif
}

// -----------------------------------------------------------------------------------------------------------------------------------

BRDFIntegrateLUT::~BRDFIntegrateLUT()
{
#if defined(DWSF_VULKAN)
    m_pipeline.reset();
    m_pipeline_layout.reset();
    m_ds.reset();
    m_ds_layout.reset();
    m_image_view.reset();
    m_image.reset();
#else
    m_program.reset();
    m_shader.reset();
    m_texture.reset();
#endif
}

// -----------------------------------------------------------------------------------------------------------------------------------
} // namespace dw